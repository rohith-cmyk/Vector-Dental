generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Clinic {
  id                 String              @id @default(uuid())
  name               String
  address            String?
  phone              String?
  email              String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  logoUrl            String?
  logoStorageKey     String?
  referralLink       ClinicReferralLink?
  contacts           Contact[]
  notifications      Notification[]
  referrals          Referral[]
  specialistProfiles SpecialistProfile[]
  users              User[]

  @@map("clinics")
}

model User {
  id                                     String                   @id @default(uuid())
  email                                  String                   @unique
  password                               String
  name                                   String
  role                                   UserRole                 @default(STAFF)
  clinicId                               String
  createdAt                              DateTime                 @default(now())
  updatedAt                              DateTime                 @updatedAt
  userType                               UserType                 @default(SPECIALIST)
  operativeReports                       OperativeReport[]        @relation("OperativeReportAuthor")
  post_treatment_reports                 post_treatment_reports[]
  referralLinks                          ReferralLink[]
  referrals_referrals_createdByIdTousers Referral[]               @relation("referrals_createdByIdTousers")
  intendedReferrals                      Referral[]               @relation("IntendedRecipient")
  specialistProfile                      SpecialistProfile?
  clinic                                 Clinic                   @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([userType])
  @@map("users")
}

model SpecialistProfile {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String   @unique @map("user_id")
  clinicId          String   @map("clinic_id")
  firstName         String?  @map("first_name")
  lastName          String?  @map("last_name")
  credentials       String?
  specialty         String?
  subSpecialties    String[] @default([]) @map("sub_specialties")
  yearsInPractice   Int?     @map("years_in_practice")
  boardCertified    Boolean  @default(false) @map("board_certified")
  languages         String[] @default([])
  insuranceAccepted String[] @default([]) @map("insurance_accepted")
  phone             String?
  email             String?
  website           String?
  address           String?
  city              String?
  state             String?
  zip               String?
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  photoUrl          String?  @map("photo_url")
  photoStorageKey   String?  @map("photo_storage_key")
  clinic            Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([clinicId])
  @@map("specialist_profiles")
}

model Contact {
  id        String        @id @default(uuid())
  clinicId  String
  name      String
  specialty String
  phone     String
  email     String
  address   String?
  notes     String?
  status    ContactStatus @default(ACTIVE)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  clinic    Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  referrals Referral[]

  @@index([clinicId])
  @@index([specialty])
  @@index([status])
  @@map("contacts")
}

model Referral {
  id                                 String                   @id @default(uuid())
  patientName                        String
  patientDob                         DateTime
  patientPhone                       String?
  patientEmail                       String?
  reason                             String
  urgency                            ReferralUrgency          @default(ROUTINE)
  status                             ReferralStatus           @default(DRAFT)
  notes                              String?
  createdAt                          DateTime                 @default(now())
  updatedAt                          DateTime                 @updatedAt
  shareToken                         String?                  @unique
  fromClinicEmail                    String?
  fromClinicId                       String
  fromClinicName                     String?
  fromClinicPhone                    String?
  gpClinicName                       String?
  insurance                          String?
  intendedRecipientId                String?
  patientFirstName                   String?
  patientLastName                    String?
  referralLinkId                     String?
  referralType                       ReferralType             @default(OUTGOING)
  referringDentist                   String?
  selectedTeeth                      String[]                 @default([])
  specialty                          String?
  statusToken                        String?                  @unique
  submittedByName                    String?
  submittedByPhone                   String?
  toClinicId                         String?
  toContactId                        String?
  statusAccessCodeHash               String?
  acceptedAt                         DateTime?                @db.Timestamptz(6)
  scheduledAt                        DateTime?                @db.Timestamptz(6)
  completedAt                        DateTime?                @db.Timestamptz(6)
  postOpScheduledAt                  DateTime?                @db.Timestamptz(6)
  createdById                        String?
  appointmentDate                    DateTime?
  appointmentNotes                   String?
  patientAttendedAt                  DateTime?
  treatmentStartedAt                 DateTime?
  treatmentCompletedAt               DateTime?
  notifications                      Notification[]
  operativeReports                   OperativeReport[]
  post_treatment_reports             post_treatment_reports[]
  files                              ReferralFile[]
  users_referrals_createdByIdTousers User?                    @relation("referrals_createdByIdTousers", fields: [createdById], references: [id])
  clinic                             Clinic                   @relation(fields: [fromClinicId], references: [id], onDelete: Cascade)
  intendedRecipient                  User?                    @relation("IntendedRecipient", fields: [intendedRecipientId], references: [id])
  referralLink                       ReferralLink?            @relation(fields: [referralLinkId], references: [id])
  contact                            Contact?                 @relation(fields: [toContactId], references: [id], onDelete: Restrict)

  @@index([fromClinicId])
  @@index([toContactId])
  @@index([toClinicId])
  @@index([intendedRecipientId])
  @@index([referralType])
  @@index([status])
  @@index([createdAt])
  @@index([referralLinkId])
  @@index([shareToken])
  @@index([statusToken])
  @@index([createdById])
  @@map("referrals")
}

model ReferralFile {
  id         String   @id @default(uuid())
  referralId String
  fileName   String
  fileType   String
  fileUrl    String
  fileSize   Int
  uploadedAt DateTime @default(now())
  mimeType   String?
  storageKey String?
  referral   Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)

  @@index([referralId])
  @@map("referral_files")
}

model OperativeReport {
  id            String                @id @default(uuid())
  referralId    String
  createdById   String
  findings      String
  diagnosis     String?
  treatmentPlan String
  comment       String?               @map("notes")
  reportDate    DateTime              @default(now())
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  files         OperativeReportFile[]
  createdBy     User                  @relation("OperativeReportAuthor", fields: [createdById], references: [id])
  referral      Referral              @relation(fields: [referralId], references: [id], onDelete: Cascade)

  @@index([referralId])
  @@index([createdById])
  @@map("operative_reports")
}

model OperativeReportFile {
  id         String           @id @default(uuid())
  fileName   String
  fileType   String
  fileUrl    String
  fileSize   Int
  storageKey String?
  mimeType   String?
  uploadedAt DateTime?        @default(now()) @db.Timestamptz(6)
  reportId   String?
  report     OperativeReport? @relation(fields: [reportId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "operative_report_files_report_id_fkey")

  @@index([reportId], map: "operative_report_files_reportid_idx")
  @@map("operative_report_files")
}

model ClinicReferralLink {
  id        String   @id @default(uuid())
  clinicId  String   @unique
  slug      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@map("clinic_referral_links")
}

model ReferralLink {
  id             String     @id @default(uuid())
  specialistId   String
  token          String     @unique
  accessCodeHash String
  isActive       Boolean    @default(true)
  label          String?
  specialty      String     @default("General Dentist")
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  specialist     User       @relation(fields: [specialistId], references: [id], onDelete: Cascade)
  referrals      Referral[]

  @@index([specialistId])
  @@index([token])
  @@map("referral_links")
}

model Notification {
  id         String           @id @default(uuid())
  clinicId   String
  userId     String?
  type       NotificationType
  referralId String?
  title      String
  message    String
  isRead     Boolean          @default(false)
  createdAt  DateTime         @default(now())
  clinic     Clinic           @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  referral   Referral?        @relation(fields: [referralId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model Feedback {
  id          String           @id @default(uuid())
  source      FeedbackSource   @default(SPECIALIST)
  type        FeedbackType
  description String
  severity    FeedbackSeverity
  userId      String?          @map("user_id")
  screen      String?
  context     Json?
  createdAt   DateTime         @default(now()) @map("created_at")

  @@index([createdAt])
  @@index([source])
  @@index([type])
  @@map("feedback")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model post_treatment_reports {
  id               String   @id
  referralId       String
  createdById      String
  treatmentSummary String
  outcome          String
  complications    String?
  recommendations  String
  followUpNeeded   Boolean  @default(false)
  reportDate       DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime
  users            User     @relation(fields: [createdById], references: [id])
  referrals        Referral @relation(fields: [referralId], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@index([referralId])
}

enum UserRole {
  ADMIN
  STAFF
  GENERAL_DENTIST
}

enum ContactStatus {
  ACTIVE
  INACTIVE
}

enum ReferralType {
  OUTGOING
  INCOMING
}

enum ReferralStatus {
  DRAFT
  SENT
  ACCEPTED
  COMPLETED
  CANCELLED
  SUBMITTED
  PENDING_REVIEW
  REJECTED
}

enum ReferralUrgency {
  ROUTINE
  URGENT
  EMERGENCY
}

enum NotificationType {
  NEW_INCOMING_REFERRAL
  REFERRAL_ACCEPTED
  REFERRAL_REJECTED
  REFERRAL_COMPLETED
  REFERRAL_STATUS_UPDATE
  SYSTEM_MESSAGE
  APPOINTMENT_SCHEDULED
  REPORT_AVAILABLE
  TREATMENT_STARTED
  TREATMENT_COMPLETED
}

enum FeedbackSource {
  SPECIALIST
  GD
}

enum FeedbackType {
  BUG
  UI_CONFUSING
  FEATURE_IDEA
  DATA_ISSUE
}

enum FeedbackSeverity {
  BLOCKING
  HIGH
  MEDIUM
  LOW
}

enum UserType {
  SPECIALIST
  GENERAL_DENTIST
}
